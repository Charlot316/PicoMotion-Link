<!DOCTYPE html>
<html>
<head>
    <title>Pico 4 Ultra Full Sync Pro</title>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        button { padding: 40px 80px; font-size: 30px; cursor: pointer; background: #FF9800; color: white; border: none; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #status { margin-top: 20px; color: #03A9F4; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Pico 4 Ultra Pro Sync</h1>
    <button id="startBtn">启动全量同步</button>
    <div id="status">Sync: Head + Hands + Buttons</div>
    <canvas id="xrCanvas" style="display:none;"></canvas>

    <script>
        const status = document.getElementById('status');
        const canvas = document.getElementById('xrCanvas');
        const gl = canvas.getContext('webgl', { xrCompatible: true });
        const targetUrl = `http://127.0.0.1:8765`;

        async function startVR() {
            try {
                const session = await navigator.xr.requestSession('immersive-vr', { requiredFeatures: ['local-floor'] });
                session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
                const refSpace = await session.requestReferenceSpace('local-floor');
                
                function onFrame(time, frame) {
                    frame.session.requestAnimationFrame(onFrame);
                    
                    // 1. 获取头部 (Viewer) 姿态
                    const viewerPose = frame.getViewerPose(refSpace);
                    if (viewerPose) {
                        fetch(targetUrl, {
                            method: 'POST', mode: 'no-cors',
                            body: JSON.stringify({
                                type: 'head',
                                position: viewerPose.transform.position,
                                orientation: viewerPose.transform.orientation
                            })
                        }).catch(() => {});
                    }

                    // 2. 获取手柄姿态
                    for (const inputSource of frame.session.inputSources) {
                        if (inputSource.gripSpace) {
                            const gripPose = frame.getPose(inputSource.gripSpace, refSpace);
                            if (gripPose) {
                                const gamepad = inputSource.gamepad;
                                const payload = {
                                    type: 'controller',
                                    handedness: inputSource.handedness,
                                    position: gripPose.transform.position,
                                    orientation: gripPose.transform.orientation,
                                    buttons: gamepad ? gamepad.buttons.map(b => ({ pressed: b.pressed, value: b.value })) : [],
                                    axes: gamepad ? [gamepad.axes[2], gamepad.axes[3]] : []
                                };
                                fetch(targetUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }).catch(() => {});
                            }
                        }
                    }

                    gl.bindFramebuffer(gl.FRAMEBUFFER, frame.session.renderState.baseLayer.framebuffer);
                    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                }
                session.requestAnimationFrame(onFrame);
                status.innerText = "数据传输中...";
            } catch (e) {
                status.innerText = "错误: " + e.message;
            }
        }
        document.getElementById('startBtn').onclick = startVR;
    </script>
</body>
</html>